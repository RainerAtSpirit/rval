
  class Reaction implements Observer {
    scheduled = false
    dirtyCount = 0
    changedCount = 0
    constructor(public src: Observable, public listener: Listener) {  }
    markDirty() {
      if (this.scheduled) return
      this.dirtyCount++
    }
    markReady(changed) {
      if (this.scheduled) return
      if (changed) this.changedCount++
      if (--this.dirtyCount === 0) if (this.changedCount) this.schedule()
    }
    schedule() {
      if (!this.scheduled) {
        this.scheduled = true
        // TODO: run scheduler here!
        pending.push(this)
        runPendingObservers()
      }
    }
    run() {
      this.scheduled = false
      this.listener(this.src())
    }
  }
